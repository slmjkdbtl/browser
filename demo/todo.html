<html>

<head>
	<title>todo</title>
</head>

<body>
	<script src="../ok.js"></script>
	<script>

const {
	t,
	css,
	render,
	state,
} = ok;

css({
	".app": {
		"width": "240px",
		"> .inputbar": {
			"width": "100%",
			"display": "flex",
			"flex-direction": "row",
			"justify-content": "space-between",
		},
		"> .list": {
			"width": "100%",
			"> .item": {
				"display": "flex",
				"flex-direction": "row",
				"justify-content": "space-between",
				"width": "100%",
				"> .info": {
					"display": "flex",
					"flex-direction": "row",
					"> .title": {
						"cursor": "pointer",
						"user-select": "none",
						"&.crossed": {
							"text-decoration": "line-through",
						},
					},
				},
				"> .delete": {
					"display": "none",
				},
				":hover > .delete": {
					"display": "block",
				},
			},
		},
	},
});

const todos = state((() => {
	if (localStorage["todo"]) {
		return JSON.parse(localStorage["todo"]).map((item) => {
			const done = state(item.done);
			done.sub(save);
			return {
				title: item.title,
				done: done,
			};
		});
	} else {
		return [];
	}
})());

function save() {
	localStorage["todo"] = JSON.stringify(todos.get().map((item) => {
		return {
			title: item.title,
			done: item.done.get(),
		};
	}));
}

// TODO: deep sub
todos.sub(save);

const input = state("");

function add() {
	if (!input.get()) {
		return;
	}
	const done = state(false);
	done.sub(save);
	todos.set([
		...todos.get(),
		{
			title: input.get(),
			done: done,
		},
	]);
	input.set("");
}

render(document.body, t(".app", {}, [
	t(".inputbar", {}, [
		t("input", {
			placeholder: "enter your new task",
			value: input,
			onkeyup(e) {
				if (e.key === "Enter") {
					add();
				}
			},
			oninput(e) {
				input.set(e.target.value);
			},
		}),
		t("button", {
			onclick: add,
		}, "add"),
	]),
	t(".list", {}, todos.every((item, idx) => {
		return t(".item", {}, [
			t(".info", {}, [
				t("input", {
					type: "checkbox",
					checked: item.done,
					onchange(e) {
						item.done.set(e.target.checked);
					},
				}),
				t(".title", {
					onclick() {
						item.done.set((c) => !c);
					},
					classes: item.done.map((c) => [ c && "crossed" ]),
				}, item.title),
			]),
			t("button.delete", {
				onclick() {
					todos.set((t) => t.filter((_, idx2) => idx2 !== idx));
				},
			}, "delete"),
		]);
	})),
]));

	</script>
</body>

</html>
